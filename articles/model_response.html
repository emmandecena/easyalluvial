<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualising Model Response • easyalluvial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Visualising Model Response">
<meta property="og:description" content="easyalluvial">
<meta property="og:image" content="https://erblast.github.io/easyalluvial/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">easyalluvial</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data_exploration.html">Data Exploration with Alluvial Plots</a>
    </li>
    <li>
      <a href="../articles/model_response.html">Visualising Model Response</a>
    </li>
    <li>
      <a href="../articles/parcats.html">Interactive Plots with parcats</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/erblast/easyalluvial/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Visualising Model Response</h1>
                        <h4 class="author">Bjönr Koneswarakantha</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/erblast/easyalluvial/blob/master/vignettes/model_response.Rmd"><code>vignettes/model_response.Rmd</code></a></small>
      <div class="hidden name"><code>model_response.Rmd</code></div>

    </div>

    
    
<p>In this tutorial I want to show how you can use alluvial plots to visualise model response in up to 4 dimensions. <code>easyalluvial</code> generates an artificial data space using fixed values for unplotted variables or uses the partial dependence plotting method. It is model agnostic but offers some convenient wrappers for <code>caret</code> models. <!--more--></p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<div id="taking-a-peek" class="section level2">
<h2 class="hasAnchor">
<a href="#taking-a-peek" class="anchor"></a>Taking a peek</h2>
<p>When building machine learning models we are usually faced with a trade-off between accuracy and interpretability. However even if we tend to lean towards accuracy and pick a modelling method that results in nearly uninterpretable models we can still make use of model agnostic interpretation techniques that have been summarized in this excellent ebook <a href="https://christophm.github.io/interpretable-ml-book/">Interpretable Machine Learning by Christoph Molnar</a>.</p>
<p>Without getting to theoretical I personally always feel the urge to simply take a peek simulate some data and see how the model reacts a method described in <a href="http://vita.had.co.nz/papers/model-vis.pdf">here</a>. In order to simulate data we can generate a a vector with a sequence of values over the entire range of a predictor variable of interest while setting all the others to their median or mode and use this artificial data space to obtain model predictions which we can plot against our variable of interest. An R package that will do this for you is (<code>plotmo</code>)[<a href="https://cran.r-project.org/web/packages/plotmo/index.html" class="uri">https://cran.r-project.org/web/packages/plotmo/index.html</a>]. Instead of ranging over 1 predictor variable we can create a data grid using 2 predictor variables and plot the response as a third dimension. However this is as far as you can go in a conventional plot. Alluvial plots can line up much more than 3 dimensions on a plane next to each other only limited by the number of flows as it will get too cluttered when there are too many of them.</p>
</div>
<div id="which-variables-to-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#which-variables-to-plot" class="anchor"></a>Which variables to plot</h2>
<p>When using conventional model response plotting beeing limited two 2 variables we can simply resolve this by generating many plots and look at them one by one. Alluvial plots require a bit more attention and cannot easily be screened and compared since visually there is so much going on. Therefore I do not recommend to brute force it by simply creating a lot of random combinations of predictor variables and multiple alluvial plots but instead to focus on those that have the highest calculated feature importance. Feature importance values are natively provided by most modelling packages. So the question is how many can we plot and it turns out 4 features will usually result in well-interpretable plot.</p>
</div>
<div id="generating-the-data-space" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-the-data-space" class="anchor"></a>Generating the data space</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">tidyverse</span>) )
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">easyalluvial</span>) )
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">mlbench</span>) )
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">randomForest</span>) )
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">recipes</span>) )
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">earth</span>) )</pre></body></html></div>
<p>We start by creating a model</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'BostonHousing'</span>)
<span class="no">df</span> <span class="kw">=</span> <span class="fu">as_tibble</span>( <span class="no">BostonHousing</span> )
<span class="no">m</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span>( <span class="no">lstat</span> ~ <span class="no">.</span>, <span class="no">df</span> )</pre></body></html></div>
<p>and looking at the importance features</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">imp</span> <span class="kw">=</span> <span class="no">m</span>$<span class="no">importance</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/tidy_imp.html">tidy_imp</a></span>(<span class="no">df</span>) <span class="co"># </span>

<span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">imp</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">vars</th>
<th align="right">imp</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">medv</td>
<td align="right">8506.2256</td>
</tr>
<tr class="even">
<td align="left">rm</td>
<td align="right">3447.9079</td>
</tr>
<tr class="odd">
<td align="left">age</td>
<td align="right">2641.0733</td>
</tr>
<tr class="even">
<td align="left">crim</td>
<td align="right">2278.3386</td>
</tr>
<tr class="odd">
<td align="left">indus</td>
<td align="right">2198.9348</td>
</tr>
<tr class="even">
<td align="left">nox</td>
<td align="right">1925.6488</td>
</tr>
<tr class="odd">
<td align="left">dis</td>
<td align="right">1895.5333</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="right">720.9968</td>
</tr>
<tr class="odd">
<td align="left">tax</td>
<td align="right">698.7340</td>
</tr>
<tr class="even">
<td align="left">ptratio</td>
<td align="right">368.0213</td>
</tr>
<tr class="odd">
<td align="left">rad</td>
<td align="right">223.8361</td>
</tr>
<tr class="even">
<td align="left">chas</td>
<td align="right">126.9927</td>
</tr>
<tr class="odd">
<td align="left">zn</td>
<td align="right">118.2477</td>
</tr>
</tbody>
</table>
<p>When generating the data space we cannot screen an infinite amount of values per variable but will have to limit ourselves to a fixed number. Then we want to create all possible combinations between these values which determines the number of flows. The visual limit for flows on an alluvial plot is somewhere around 1000 flows. Thus I recommend to go with 5 values which will result in 5 x 5 X 5 X 5 –&gt; 625 combinations and the same number of flows. That also leaves some wiggeling room if one of the top 4 variables is a factor with more than 5 levels. <code><a href="../reference/get_data_space.html">get_data_space()</a></code> will split the range of a variable into 3 and pick the median of each split and add the variable minimum and the maximum to the set.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">dspace</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_data_space.html">get_data_space</a></span>(<span class="no">df</span>, <span class="no">imp</span>
                        , <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span> <span class="co"># specifies the number of variables</span>
                        , <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span> <span class="co"># the number of values per variable</span>
                        )

<span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>( <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dspace</span>, <span class="fl">10</span>) )</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">medv</th>
<th align="right">rm</th>
<th align="right">age</th>
<th align="right">crim</th>
<th align="right">indus</th>
<th align="right">nox</th>
<th align="right">dis</th>
<th align="right">b</th>
<th align="right">tax</th>
<th align="right">ptratio</th>
<th align="right">rad</th>
<th align="left">chas</th>
<th align="right">zn</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">0.00632</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">0.12000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">2.38000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">9.51000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">88.97620</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">0.00632</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">0.12000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">2.38000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">9.51000</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">88.97620</td>
<td align="right">9.69</td>
<td align="right">0.538</td>
<td align="right">3.20745</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Total rows in dspace: 625</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">dspace</span> <span class="kw">%&gt;%</span>
  <span class="fu">summarise_all</span>( ~ <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">.</span>) ) ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">medv</th>
<th align="right">rm</th>
<th align="right">age</th>
<th align="right">crim</th>
<th align="right">indus</th>
<th align="right">nox</th>
<th align="right">dis</th>
<th align="right">b</th>
<th align="right">tax</th>
<th align="right">ptratio</th>
<th align="right">rad</th>
<th align="right">chas</th>
<th align="right">zn</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">5</td>
<td align="right">5</td>
<td align="right">5</td>
<td align="right">5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr></tbody>
</table>
</div>
<div id="generating-model-response" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-model-response" class="anchor"></a>Generating model response</h2>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">pred</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">m</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">dspace</span>)</pre></body></html></div>
</div>
<div id="plotting" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting" class="anchor"></a>Plotting</h2>
<p>The predictions will be binned as well into 5 bins. Binning options can be passed as a list via the <code>params_bin_numeric_pred</code> parameter.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">p</span> <span class="kw">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span>(<span class="no">pred</span>, <span class="no">dspace</span>, <span class="no">imp</span>
                            , <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span>
                            , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span> )
<span class="no">p</span></pre></body></html></div>
<p><img src="model_response_files/figure-html/alluv1-1.png" width="960"></p>
<p>We can see the binned range of predictions and explore by which variable combination they have been created by tracing the coloured flows. The stratum labels of the prediction variables indicate the value of the variable and which fraction of the flows of that colour (prediction variable bin range) pass through that stratum.</p>
</div>
<div id="marginal-histograms" class="section level2">
<h2 class="hasAnchor">
<a href="#marginal-histograms" class="anchor"></a>Marginal histograms</h2>
<p>As well as for other <code>easyalluvial</code> plots we can add marginal histograms and as a bonus also the feature importance.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">p_grid</span> <span class="kw">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span>(<span class="no">p</span>, <span class="kw">data_input</span> <span class="kw">=</span> <span class="no">df</span>
                                 , <span class="kw">plot</span> <span class="kw">=</span> <span class="no">F</span> <span class="co"># plot only after adding feature importance</span>
                                 , <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">50</span> <span class="co"># to increase distance between ridge plots, Default: 400</span>
                                 ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span>( <span class="kw">p</span> <span class="kw">=</span> <span class="no">p</span>, <span class="kw">data_input</span> <span class="kw">=</span> <span class="no">df</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-7-1.png" width="1152"></p>
<p>We can see the original distribution of the variables, the lines indicate the position of the values as picked by <code><a href="../reference/get_data_space.html">get_data_space()</a></code>. When comparing the distribution of the predictions against the original distribution of <code>lstat</code> we see that the range of the predictions in response to the artificial dataspace do not cover all of the range of <code>lstat</code>. Which most likely means that all possible combinations of the 4 plotted variables in combination with moderate values for all other predictors will not give any extreme values. Which we can further explore, first we will need to check whether the model is capable of making predictions in the lower and upper ranges of <code>lsat</code>. We can use <code><a href="../reference/plot_hist.html">plot_hist()</a></code> to only plot the distributions and add the prediction for the training data set using the <code>pred_train</code> parameter.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">pred_train</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">m</span>)

<span class="fu"><a href="../reference/plot_hist.html">plot_hist</a></span>(<span class="st">'pred'</span>, <span class="no">p</span>, <span class="no">df</span>
          , <span class="kw">pred_train</span> <span class="kw">=</span> <span class="no">pred_train</span> <span class="co"># pred_train can also be passed to add_marginal_histograms()</span>
          , <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">50</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-8-1.png" width="288" style="display: block; margin: auto;"></p>
<p>We see that the training prediction also do not completely cover all of the <code>lstat</code> range but more of it than the predictions from the artificial data space.</p>
<p>If we wanted to emphasize this we can bin the data space predictions on the basis of the training predictions. In this case it makes sense to increase the number of bins for the predictions in order not to loose resolution on the plot.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">p</span> <span class="kw">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span>(<span class="no">pred</span>, <span class="no">dspace</span>, <span class="no">imp</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">7</span>
                            , <span class="kw">bin_labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"LLL"</span>,<span class="st">"LL"</span>, <span class="st">"ML"</span>, <span class="st">"M"</span>, <span class="st">"MH"</span>, <span class="st">"HH"</span>, <span class="st">"HHH"</span>)
                            , <span class="kw">pred_train</span> <span class="kw">=</span> <span class="no">pred_train</span>
                            , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span> )

<span class="fu"><a href="../reference/plot_hist.html">plot_hist</a></span>(<span class="st">'pred'</span>, <span class="no">p</span>, <span class="no">df</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">50</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/p_hist-1.png" width="288" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">p_grid</span> <span class="kw">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span>(<span class="no">p</span>, <span class="kw">data_input</span> <span class="kw">=</span> <span class="no">df</span>
                                 , <span class="kw">plot</span> <span class="kw">=</span> <span class="no">F</span> <span class="co"># plot only after adding feature importance</span>
                                 , <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">50</span> <span class="co"># to increase distance between ridge plots, Default: 400</span>
                                 ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span>( <span class="kw">p</span> <span class="kw">=</span> <span class="no">p</span>, <span class="kw">data_input</span> <span class="kw">=</span> <span class="no">df</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-9-1.png" width="1152"></p>
</div>
</div>
<div id="what-feature-combinations-are-needed-to-obtain-predictions-in-the-lower-and-higher-ranges-of-lstat" class="section level1">
<h1 class="hasAnchor">
<a href="#what-feature-combinations-are-needed-to-obtain-predictions-in-the-lower-and-higher-ranges-of-lstat" class="anchor"></a>What feature combinations are needed to obtain predictions in the lower and higher ranges of <code>lstat</code>?</h1>
<p>We can add the training predictions to the training data and assign the variables not covered by the model response plot to bins. We can then create an alluvial plot over the entire training dataframe in order to trace the <code>lstat</code> ranges not covered by the model response alluvial plot above. Since we are only interested in those observations we remove all other flows from the plot by setting their color to <code>NA</code>.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">pred_train</span>) - <span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">pred</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">pred</span>),<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">pred_train</span>) + <span class="fl">1</span> )

<span class="no">df_inv</span> <span class="kw">=</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(-<span class="no">lstat</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>( <span class="kw">pred_train</span> <span class="kw">=</span> <span class="no">pred_train</span>
          , <span class="kw">pred_train</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">pred_train</span>, <span class="no">breaks</span>) ) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>( <span class="no">pred_train</span>, <span class="fu">one_of</span>(<span class="no">imp</span>$<span class="no">vars</span>) ) <span class="co"># order by feature importance</span>

<span class="no">p</span> <span class="kw">=</span> <span class="fu"><a href="../reference/alluvial_wide.html">alluvial_wide</a></span>(<span class="no">df_inv</span>, <span class="kw">bin_labels</span> <span class="kw">=</span> <span class="st">'min_max'</span>
                  , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">3</span>
                  , <span class="kw">col_vector_flow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'blue'</span>, <span class="fl">NA</span>, <span class="st">'orange'</span>)
                  , <span class="kw">colorful_fill_variable_stratum</span> <span class="kw">=</span> <span class="no">F</span>)

<span class="no">p_grid</span> <span class="kw">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span>(<span class="no">p</span>, <span class="no">df_inv</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-10-1.png" width="1152"></p>
<p>We can see that for the upper ranges of <code>lstat</code> a pretty specific combination values is required from 8 feature variables from <code>medv</code> until <code>tax</code> only then begin the flows to scatter over the entire range of the following variables. The lower range values of <code>lstat</code> start to scatter at <code>crim</code> or <code>dis</code>. Interestingly there seems to be a set of houses that branches off from the other houses in the lower range of <code>lstat</code> predictions already at the third feature, <code>age</code>. We could potentially explore this further, as a reminder you can get the binned input data for each alluvial plot by calling <code>p$data_key</code> and trace the variables of interest.</p>
</div>
<div id="caret-wrapper" class="section level1">
<h1 class="hasAnchor">
<a href="#caret-wrapper" class="anchor"></a><code>caret</code> wrapper</h1>
<p><code>caret</code> provides a uniformous interface for training and calling a lot of machine learning models as well as for calculating feature importance. <code>easyalluvial</code> provides a function that wraps the above described workflow into one single call. Note that feature importance values are slightly different. <code>randomForest</code> returns a combined importance for all levels of a factor variable while <code>caret</code> splits them up. <code><a href="../reference/tidy_imp.html">tidy_imp()</a></code> aggregates them and uses the maximum value of all values. This behaviour can be adjusted by passing another aggregating function to the <code>.f</code> parameter.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">train</span> <span class="kw">=</span> <span class="kw pkg">caret</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span>( <span class="no">lstat</span> ~ <span class="no">.</span>
                     , <span class="no">df</span>
                     , <span class="kw">method</span> <span class="kw">=</span> <span class="st">'rf'</span>
                     , <span class="kw">trControl</span> <span class="kw">=</span> <span class="kw pkg">caret</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span>( <span class="kw">method</span> <span class="kw">=</span> <span class="st">'none'</span> )
                     , <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span> )

<span class="fu"><a href="../reference/alluvial_model_response_caret.html">alluvial_model_response_caret</a></span>(<span class="no">train</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span>
                              , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-11-1.png" width="960"></p>
</div>
<div id="advantages" class="section level1">
<h1 class="hasAnchor">
<a href="#advantages" class="anchor"></a>Advantages</h1>
<p>Model response alluvial plots can help us to get an immediate intuitive understanding how predictions of a certain range can be generated by the model. They can be understood by none-statistical stakeholders and invite the viewer to start exploring and question the decision making process of the model while also conveying an appreciation for the model complexity as flows branch out to the variables of lower feature importance.</p>
</div>
<div id="partial-dependence-plotting-method" class="section level1">
<h1 class="hasAnchor">
<a href="#partial-dependence-plotting-method" class="anchor"></a>Partial Dependence Plotting Method</h1>
<p>When simulating artificial data space we need to be aware that we will create data space that is outside the feature distribution space of our original training data. In this example we could be creating houses that cannot exist as such maybe a 5 square meter appartment with 10 bedrooms. We have to keep this in mind when interpretating the plot. Moreover by setting all the none-plotted values to median/mode we might also be creating observations outside the possible feature distribution space but this will be hidden and not foreseeable even by somebody who has some subject matter expertise. Simply imagine how likely it would be if I measure a hundred different features of the inhabitants of a certain country how likely will it be that I find one person that is exactly the average for all of those measurements? So to alleviate this we can use the partial dependency plotting method:</p>
<ol style="list-style-type: decimal">
<li><p>construct the data space as described above, but instead of setting all none-plotted variables to median/mode we set them to the values found in the first row of the training data.</p></li>
<li><p>Repeat 1. for each row</p></li>
<li><p>Use all data spaces to get model predictions</p></li>
<li><p>Average model predictions</p></li>
</ol>
<p>Using this method we reduce the risk of simulating data outside the feature distribution space concerning the variables that are not plotted.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">pred</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_pdp_predictions.html">get_pdp_predictions</a></span>(<span class="no">df</span>, <span class="no">imp</span>, <span class="no">m</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span>)


<span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span>(<span class="no">pred</span>, <span class="no">dspace</span>, <span class="no">imp</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>
                        , <span class="kw">method</span> <span class="kw">=</span> <span class="st">'pdp'</span> <span class="co"># changes title and caption</span>
                        , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span> )</pre></body></html></div>
<p><img src="model_response_files/figure-html/pdp-1.png" width="960"></p>
<p>thanks to the uniform modelling interface of <code>caret</code> <code><a href="../reference/alluvial_model_response_caret.html">alluvial_model_response_caret()</a></code> can call <code><a href="../reference/get_pdp_predictions.html">get_pdp_predictions()</a></code> directly.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/alluvial_model_response_caret.html">alluvial_model_response_caret</a></span>(<span class="no">train</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span>
                              , <span class="kw">method</span> <span class="kw">=</span> <span class="st">'pdp'</span>
                              , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span> )</pre></body></html></div>
<p><img src="model_response_files/figure-html/pdp_caret-1.png" width="960"></p>
<div id="a-note-on-feature-importance" class="section level2">
<h2 class="hasAnchor">
<a href="#a-note-on-feature-importance" class="anchor"></a>A note on feature importance</h2>
<p>Calculating feature importance in a dataset with strongly correlating variables will lead to inaccurate results. It usually means that two strongly correlating variables share the importance that would be accredited to them if only one of them was present in the data set. Further some feature importance calculation methods require the model to be trained with scaled, centered and potentially normalized (transformed to be more normally distributed) numerical variables in order to deliver meaningful results. We can use the <code>recipes</code> package to perform these tasks. Using the below described workflow we can create the artificial dataspace with untransformed numerical values which will give us more meaningful output.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co"># filter correlating variables recipe- ------------------------------</span>
<span class="co"># caret tends to complain if recipe filters any variables, therefore</span>
<span class="co"># we use two recipes</span>

<span class="no">rec_filt_corrs</span> <span class="kw">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">df</span>, <span class="no">lstat</span> ~ <span class="no">.</span> ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_corr.html">step_corr</a></span>( <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric</a></span>()
             , - <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>()
             , <span class="kw">threshold</span> <span class="kw">=</span> <span class="fl">0.7</span> ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>()


<span class="no">df_filt_corrs</span> <span class="kw">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span>(<span class="no">rec_filt_corrs</span>, <span class="no">df</span>)

<span class="co"># transformation recipe --------------------------------------------</span>
<span class="no">rec_trans</span> <span class="kw">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>( <span class="no">df_filt_corrs</span>, <span class="no">lstat</span> ~ <span class="no">.</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_center.html">step_center</a></span>( <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric</a></span>(), - <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>() ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_scale.html">step_scale</a></span>( <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric</a></span>(), - <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>() ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_YeoJohnson.html">step_YeoJohnson</a></span>( <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric</a></span>(), - <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>() ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>()

<span class="co"># train and plot ---------------------------------------------------</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">train</span> <span class="kw">=</span> <span class="kw pkg">caret</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span>( <span class="no">rec_trans</span>
                     , <span class="no">df_filt_corrs</span>
                     , <span class="kw">method</span> <span class="kw">=</span> <span class="st">'earth'</span>
                     , <span class="kw">trControl</span> <span class="kw">=</span> <span class="kw pkg">caret</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span>( <span class="kw">method</span> <span class="kw">=</span> <span class="st">'cv'</span>
                                                        , <span class="kw">search</span> <span class="kw">=</span> <span class="st">'random'</span>)
                     , <span class="kw">tuneLength</span> <span class="kw">=</span> <span class="fl">100</span>)

<span class="no">pred_train</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">train</span>, <span class="no">df_filt_corrs</span>)

<span class="no">p</span> <span class="kw">=</span> <span class="fu"><a href="../reference/alluvial_model_response_caret.html">alluvial_model_response_caret</a></span>(<span class="no">train</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">5</span>
                                  , <span class="kw">pred_train</span> <span class="kw">=</span> <span class="no">pred_train</span>
                                  , <span class="kw">stratum_label_size</span> <span class="kw">=</span> <span class="fl">2.8</span> )

<span class="no">p_grid</span> <span class="kw">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span>(<span class="no">p</span>, <span class="no">df</span>, <span class="kw">plot</span> <span class="kw">=</span> <span class="no">F</span>
                                 , <span class="kw">pred_var</span> <span class="kw">=</span> <span class="st">'lstat'</span>
                                 , <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">50</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span>(<span class="no">p</span>, <span class="no">df</span>)</pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-12-1.png" width="1152"></p>
</div>
<div id="none-regression-models" class="section level2">
<h2 class="hasAnchor">
<a href="#none-regression-models" class="anchor"></a>None-regression models</h2>
<p>Works the same way.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">df</span> <span class="kw">=</span> <span class="fu">select</span>(<span class="no">mtcars2</span>, -<span class="no">ids</span>)
<span class="no">m</span> <span class="kw">=</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span>( <span class="no">am</span> ~ <span class="no">.</span>, <span class="no">df</span>)
<span class="no">imp</span> <span class="kw">=</span> <span class="no">m</span>$<span class="no">importance</span>
<span class="no">dspace</span> <span class="kw">=</span> <span class="fu"><a href="../reference/get_data_space.html">get_data_space</a></span>(<span class="no">df</span>, <span class="no">imp</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">3</span>)

<span class="no">pred</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">m</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">dspace</span>,<span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>)
<span class="no">p</span> <span class="kw">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span>(<span class="no">pred</span>, <span class="no">dspace</span>, <span class="no">imp</span>, <span class="kw">degree</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="no">p</span></pre></body></html></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="limitations" class="section level2">
<h2 class="hasAnchor">
<a href="#limitations" class="anchor"></a>Limitations</h2>
<ul>
<li>There is a loss of information when binning the numerical variables</li>
<li>The combinations generated when making the grid might be outside the feature distribution space (generate combinations that are impossible)</li>
<li>We only look at the combination of 4 features and disregard the others</li>
</ul>
<p>To alleviate this you can reduce the complexity of the model by reducing features (take out correlating variables) or use additional model exploration methods such as classical PDPs, ALE plots, Shapely values, etc, …</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
